name: üöÄ K3d Local Deploy

# Optimized workflow for K3d deployment with tiered Docker images
on:
  push:
    branches: [ main, master, dev ]
    paths:
      - 'services/**'
      - 'shared/**'
      - 'requirements-*.txt'
      - 'Dockerfile.*'
      - 'scripts/build-docker-images.sh'
      - 'k8s/k3s-production/**'
  workflow_dispatch:
    inputs:
      rebuild_all:
        description: 'Rebuild all images (ignores cache)'
        required: false
        default: 'false'
        type: boolean
      deploy_only:
        description: 'Deploy only (skip build)'
        required: false
        default: 'false'
        type: boolean

env:
  K3S_NAMESPACE: crypto-core-production
  K3D_CLUSTER: crypto-k3s

jobs:
  build-and-deploy:
    name: üèóÔ∏è Build & Deploy to K3d
    runs-on: self-hosted
    environment: k3d-local
    timeout-minutes: 60
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4

    - name: üîç Check Disk Space
      run: |
        echo "=== Initial disk usage ==="
        df -h
        AVAILABLE=$(df --output=avail -BG / | tail -n1 | tr -d 'G')
        echo "Available: ${AVAILABLE}GB"
        if [ "$AVAILABLE" -lt 25 ]; then
          echo "‚ùå ERROR: Insufficient disk space (${AVAILABLE}GB < 25GB required for ML images)"
          echo "Run: docker system prune -af --volumes"
          exit 1
        fi

    - name: üê≥ Verify K3d Cluster
      run: |
        echo "Checking K3d cluster status..."
        if ! k3d cluster list | grep -q "${{ env.K3D_CLUSTER }}"; then
          echo "‚ùå K3d cluster '${{ env.K3D_CLUSTER }}' not found"
          echo "Create it with: k3d cluster create ${{ env.K3D_CLUSTER }} --servers 1 --agents 3"
          exit 1
        fi
        
        echo "‚úÖ K3d cluster found"
        kubectl cluster-info
        kubectl get nodes

    - name: üèóÔ∏è Build Optimized Docker Images
      if: ${{ inputs.deploy_only != 'true' }}
      run: |
        cd ${{ github.workspace }}
        
        echo "Building all 12 collectors with tiered requirements..."
        chmod +x scripts/build-docker-images.sh
        
        if [ "${{ inputs.rebuild_all }}" = "true" ]; then
          echo "üîÑ Forcing rebuild of all images (no cache)"
          docker system prune -f
          ./scripts/build-docker-images.sh
        else
          echo "üöÄ Building images with cache"
          ./scripts/build-docker-images.sh
        fi
        
        echo "=== Build complete - checking images ==="
        docker images | grep crypto-enhanced | head -15

    - name: üìä Image Size Report
      if: ${{ inputs.deploy_only != 'true' }}
      run: |
        echo "## üìä Docker Image Sizes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | grep -E "REPOSITORY|crypto-enhanced|crypto-ml" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        TOTAL_SIZE=$(docker images --format "{{.Size}}" | grep -E "MB|GB" | sed 's/MB/*1/; s/GB/*1000/' | bc | awk '{sum+=$1} END {print sum/1000 "GB"}')
        echo "**Total Size:** ~$TOTAL_SIZE" >> $GITHUB_STEP_SUMMARY

    - name: üì¶ Import Images to K3d
      if: ${{ inputs.deploy_only != 'true' }}
      run: |
        echo "Importing all collector images to K3d cluster..."
        
        k3d image import \
          crypto-enhanced-news-collector:latest \
          crypto-enhanced-news-collector-sub:latest \
          crypto-enhanced-crypto-prices-service:latest \
          crypto-enhanced-onchain-collector:latest \
          crypto-enhanced-technical-indicators:latest \
          crypto-enhanced-macro-collector-v2:latest \
          crypto-enhanced-derivatives-collector:latest \
          crypto-enhanced-ml-market-collector:latest \
          crypto-enhanced-ohlc-collector:latest \
          crypto-enhanced-technical-calculator:latest \
          crypto-enhanced-materialized-updater:latest \
          crypto-enhanced-sentiment-ml:latest \
          -c ${{ env.K3D_CLUSTER }}
        
        echo "‚úÖ All images imported to K3d"

    - name: üöÄ Deploy to K3d
      run: |
        echo "Deploying to K3d cluster..."
        
        # Create namespace if it doesn't exist
        kubectl create namespace ${{ env.K3S_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
        
        # Apply configuration
        kubectl apply -f k8s/k3s-production/config.yaml || echo "Config file not found"
        kubectl apply -f k8s/k3s-production/namespace.yaml || echo "Namespace file applied via direct create"
        
        # Deploy services
        kubectl apply -f k8s/k3s-production/services-deployment-updated.yaml
        
        echo "‚úÖ Deployment manifests applied"

    - name: ‚ôªÔ∏è Restart Deployments
      run: |
        echo "Restarting all deployments to pull new images..."
        kubectl rollout restart deployment -n ${{ env.K3S_NAMESPACE }}
        
        echo "Waiting for deployments to stabilize..."
        sleep 30

    - name: üìä Deployment Status
      run: |
        echo "=== Deployment Status ==="
        kubectl get pods -n ${{ env.K3S_NAMESPACE }}
        
        echo ""
        echo "=== Pod Status Summary ==="
        kubectl get pods -n ${{ env.K3S_NAMESPACE }} --no-headers | awk '{print $3}' | sort | uniq -c
        
        echo ""
        echo "=== Service Status ==="
        kubectl get services -n ${{ env.K3S_NAMESPACE }}

    - name: üîç Health Check
      run: |
        echo "Checking pod health..."
        
        # Wait for pods to be ready
        sleep 60
        
        RUNNING=$(kubectl get pods -n ${{ env.K3S_NAMESPACE }} --field-selector=status.phase=Running --no-headers | wc -l)
        TOTAL=$(kubectl get pods -n ${{ env.K3S_NAMESPACE }} --no-headers | wc -l)
        
        echo "Running pods: $RUNNING/$TOTAL"
        
        if [ $RUNNING -eq 0 ]; then
          echo "‚ùå No pods running - checking logs..."
          kubectl get pods -n ${{ env.K3S_NAMESPACE }}
          exit 1
        elif [ $RUNNING -lt $((TOTAL * 75 / 100)) ]; then
          echo "‚ö†Ô∏è Less than 75% pods running"
          kubectl get pods -n ${{ env.K3S_NAMESPACE }} | grep -v Running
        else
          echo "‚úÖ Deployment healthy"
        fi

    - name: üìã Deployment Summary
      if: always()
      run: |
        echo "## üöÄ K3d Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Cluster:** ${{ env.K3D_CLUSTER }}" >> $GITHUB_STEP_SUMMARY
        echo "**Namespace:** ${{ env.K3S_NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Pod Status:" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        kubectl get pods -n ${{ env.K3S_NAMESPACE }} 2>/dev/null || echo "Unable to retrieve pod status" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Quick Commands:" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "# View logs" >> $GITHUB_STEP_SUMMARY
        echo "kubectl logs -f deployment/<service-name> -n ${{ env.K3S_NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Check status" >> $GITHUB_STEP_SUMMARY
        echo "kubectl get pods -n ${{ env.K3S_NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
