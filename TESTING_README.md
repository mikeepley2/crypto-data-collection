# ğŸ§ª Comprehensive Testing Framework for Crypto Data Collection\n\nThis testing framework provides comprehensive validation of all crypto data collectors using Docker containers and real API calls.\n\n## ğŸ“‹ Overview\n\n### What This Framework Tests\n\nâœ… **All 9 Collector Services**\n- Price Collection (CoinGecko API)\n- Onchain Collection (CoinGecko Premium + DeFiLlama)\n- Macro Collection (FRED API)\n- News Collection (Guardian API)\n- Technical Collection (indicator calculations)\n- Sentiment Collection (ML-based analysis)\n- Derivatives Collection (multi-exchange options/futures)\n- OHLC Collection (candlestick data)\n- Market Collection (traditional markets)\n- Placeholder Manager (centralized data management)\n\nâœ… **Real API Integration Testing**\n- Actual API calls to CoinGecko, FRED, Guardian APIs\n- Rate limiting compliance validation\n- Error handling and recovery testing\n- API key management and rotation\n\nâœ… **Database Population Verification**\n- Complete schema validation\n- Data completeness percentage tracking\n- Cross-table consistency checks\n- Performance optimization validation\n\nâœ… **Docker Test Containers**\n- Isolated test environment\n- Production-like service orchestration\n- Database and Redis containers\n- Automated health checks\n\n## ğŸš€ Quick Start\n\n### 1. Prerequisites\n\n```bash\n# Docker and Docker Compose\ndocker --version\ndocker compose version\n\n# Python 3.11+\npython --version\n\n# Install test dependencies\npip install -r requirements-test.txt\n```\n\n### 2. API Keys (Pre-configured)\n\n```bash\n# API keys are hardcoded in the test configuration:\n# - CoinGecko Premium: CG-94NCcVD2euxaGTZe94bS2oYz  \n# - FRED Economic Data: 35478996c5e061d0fc99fc73f5ce348d\n# - Guardian News: test_guardian_key (placeholder)\n\n# No additional setup required - tests use production API keys\n```\n\n### 3. Run Complete Test Suite\n\n```bash\n# Run all tests with Docker containers\npython run_tests.py\n\n# Run specific test types\npython run_tests.py --test-types integration database\n\n# Keep containers running for debugging\npython run_tests.py --no-cleanup\n```\n\n## ğŸ—ï¸ Architecture\n\n### Test Structure\n\n```\ntests/\nâ”œâ”€â”€ conftest.py                 # Shared fixtures and configuration\nâ”œâ”€â”€ pytest.ini                 # pytest configuration\nâ”œâ”€â”€ test_database_validation.py # Database schema and consistency tests\nâ”œâ”€â”€ integration/                # Real API integration tests\nâ”‚   â”œâ”€â”€ test_enhanced_price_collector.py\nâ”‚   â”œâ”€â”€ test_enhanced_derivatives_collector.py\nâ”‚   â”œâ”€â”€ test_enhanced_macro_collector.py\nâ”‚   â”œâ”€â”€ test_enhanced_market_collector.py\nâ”‚   â”œâ”€â”€ test_enhanced_ohlc_collector.py\nâ”‚   â””â”€â”€ test_enhanced_placeholder_manager.py\nâ”œâ”€â”€ fixtures/                   # Test data and database setup\nâ”‚   â”œâ”€â”€ test-schema.sql        # Test database schema\nâ”‚   â””â”€â”€ test-data.sql          # Sample test data\nâ”œâ”€â”€ configs/                    # Test configuration\nâ”‚   â””â”€â”€ nginx.conf             # API rate limiting proxy\nâ””â”€â”€ Dockerfile.test-runner      # Test execution container\n```\n\n### Docker Test Environment\n\n```yaml\n# docker-compose.test.yml provides:\nservices:\n  test-mysql:     # MySQL 8.0 test database\n  test-redis:     # Redis cache\n  api-proxy:      # Nginx rate limiting proxy\n  \n  # Collector test containers:\n  onchain-collector-test:  # Port 8000\n  price-collector-test:    # Port 8001 \n  macro-collector-test:    # Port 8002\n  news-collector-test:     # Port 8003\n  technical-collector-test: # Port 8004\n  sentiment-collector-test: # Port 8005\n  \n  test-runner:    # pytest execution container\n```\n\n## ğŸ”¬ Test Categories\n\n### Integration Tests (`tests/integration/`)\n\n**Real API Testing with:**\n- Actual CoinGecko API calls (with test API keys)\n- FRED economic data retrieval\n- Guardian news API integration\n- Rate limiting compliance validation\n- Database storage verification\n\n**Example Test:**\n```python\n@pytest.mark.integration\n@pytest.mark.real_api\ndef test_real_api_bitcoin_price_collection(collector_endpoints, test_api_keys, rate_limiter):\n    \"\"\"Test collecting real Bitcoin data from CoinGecko\"\"\"\n    rate_limiter('coingecko')\n    \n    response = requests.post(\n        f\"{collector_endpoints['price']}/api/v1/collect\",\n        json={\"symbols\": [\"bitcoin\"]},\n        headers={\"X-API-Key\": test_api_keys['coingecko']}\n    )\n    \n    assert response.status_code == 200\n    # Verify data stored in test database\n```\n\n### Database Validation Tests (`test_database_validation.py`)\n\n**Schema Validation:**\n- All required tables exist\n- `data_completeness_percentage` columns present\n- Proper indexes for performance\n- Referential integrity constraints\n\n**Data Quality Validation:**\n- Completeness percentages within 0-100% range\n- Cross-table timestamp alignment\n- Symbol consistency across tables\n- Data freshness validation\n\n### Unit Tests (Enhanced existing tests)\n\n**Collector-Specific Testing:**\n- Health endpoint validation\n- Error handling scenarios\n- Data transformation logic\n- Configuration management\n\n## ğŸ“Š Test Execution and Reporting\n\n### Automated Test Reports\n\nThe test runner generates comprehensive reports:\n\n```\nğŸ“Š Crypto Data Collection Test Report\n\nğŸ¯ Test Summary\n- Unit Tests: âœ… PASSED (15.2s)\n- Integration Tests: âœ… PASSED (45.8s) \n- Database Tests: âœ… PASSED (8.3s)\n\nğŸ“ˆ Test Coverage\n- Overall coverage: 87%\n- Critical paths: 95%\n- API endpoints: 100%\n\nğŸ”§ Recommendations\n- All tests passing\n- Monitor API rate limits\n- Review slow database queries\n```\n\n### Test Markers\n\nUse pytest markers to run specific test subsets:\n\n```bash\n# Real API tests only\npytest -m \"real_api\"\n\n# Database tests only  \npytest -m \"database\"\n\n# CoinGecko API specific tests\npytest -m \"coingecko\"\n\n# Slow tests (skip for quick validation)\npytest -m \"not slow\"\n```\n\n## ğŸ”§ Configuration\n\n### Environment Variables\n\n```bash\n# Test Database\nDB_HOST=localhost\nDB_PORT=3307\nDB_USER=test_user\nDB_PASSWORD=test_password\nDB_NAME=crypto_prices_test\n\n# Redis Cache  \nREDIS_HOST=localhost\nREDIS_PORT=6380\n\n# API Keys (for real API testing)\nCOINGECKO_TEST_KEY=your_test_key\nFRED_TEST_KEY=your_fred_key\nGUARDIAN_TEST_KEY=your_guardian_key\n\n# Test Configuration\nENVIRONMENT=test\nTESTING=1\nLOG_LEVEL=DEBUG\n```\n\n### pytest.ini Configuration\n\n```ini\n[tool:pytest]\naddopts = -v --strict-markers --cov=services\ntestpaths = tests\nmarkers =\n    integration: Integration tests with real databases/APIs\n    real_api: Tests making actual API calls\n    database: Database validation tests\n    slow: Tests taking >30 seconds\n    performance: Performance benchmarking tests\n```\n\n## ğŸ› Debugging and Troubleshooting\n\n### Keep Containers Running\n\n```bash\n# Run tests but keep containers for debugging\npython run_tests.py --no-cleanup\n\n# Connect to test database\nmysql -h localhost -P 3307 -u test_user -ptest_password crypto_prices_test\n\n# Check container logs\ndocker logs crypto-data-collection-price-collector-test-1\n```\n\n### Common Issues\n\n**API Rate Limits:**\n- Use test API keys with appropriate limits\n- Tests include rate limiting delays\n- Monitor API usage in test output\n\n**Database Connection:**\n- Ensure MySQL container is healthy\n- Check port 3307 availability\n- Verify test schema was created\n\n**Service Dependencies:**\n- Wait for all services to be ready\n- Check health endpoints before testing\n- Review Docker Compose service dependencies\n\n## ğŸ“ˆ Performance Benchmarking\n\n### Database Performance Tests\n\n```python\n@pytest.mark.performance\ndef test_bulk_insert_performance(test_mysql_connection):\n    \"\"\"Test database insertion performance\"\"\"\n    # Insert 1000 records and measure time\n    assert insertion_time < 5.0  # Should complete in under 5 seconds\n```\n\n### API Response Time Tests\n\n```python\n@pytest.mark.performance\ndef test_api_response_times(collector_endpoints):\n    \"\"\"Test API response times under normal load\"\"\"\n    # Measure response times for each endpoint\n    assert avg_response_time < 2.0  # Should respond in under 2 seconds\n```\n\n## ğŸš€ CI/CD Integration\n\n### GitHub Actions Example\n\n```yaml\nname: Comprehensive Tests\non: [push, pull_request]\n\njobs:\n  test:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v3\n      - name: Run comprehensive tests\n        env:\n          COINGECKO_TEST_KEY: ${{ secrets.COINGECKO_TEST_KEY }}\n          FRED_TEST_KEY: ${{ secrets.FRED_TEST_KEY }}\n        run: python run_tests.py\n      \n      - name: Upload test results\n        uses: actions/upload-artifact@v3\n        with:\n          name: test-results\n          path: test-results/\n```\n\n## ğŸ“š Best Practices\n\n### Writing New Tests\n\n1. **Use Real APIs When Possible**\n   - Provides most accurate validation\n   - Include rate limiting compliance\n   - Handle API errors gracefully\n\n2. **Database Validation**\n   - Always check data completeness percentages\n   - Verify cross-table consistency\n   - Test with realistic data volumes\n\n3. **Test Isolation**\n   - Each test should be independent\n   - Use test database cleanup fixtures\n   - Don't rely on test execution order\n\n### Extending the Framework\n\n1. **Adding New Collector Tests**\n   - Follow existing test patterns\n   - Include health/readiness endpoint tests\n   - Add database storage validation\n   - Test error handling scenarios\n\n2. **Custom Test Markers**\n   - Add markers to `pytest.ini`\n   - Document marker usage\n   - Use for test categorization\n\n## ğŸ”— Related Documentation\n\n- [Collector Service Documentation](../services/README.md)\n- [Database Schema Guide](../shared/centralized_table_config.py)\n- [API Configuration](../shared/centralized_db_config.py)\n- [Docker Compose Setup](../docker-compose.yml)\n\n---\n\n**ğŸ¯ Goal:** Ensure 100% reliability and data quality across all crypto data collection services with comprehensive real-world testing.\n\n**ğŸ“ Support:** Check test output logs and generated reports in `test-results/` directory for detailed diagnostics.