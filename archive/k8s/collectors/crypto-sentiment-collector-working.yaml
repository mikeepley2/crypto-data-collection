apiVersion: apps/v1
kind: Deployment
metadata:
  name: crypto-sentiment-collector-working
  namespace: crypto-data-collection
  labels:
    app: crypto-sentiment-collector-working
    component: data-collector
    market-type: crypto
spec:
  replicas: 1
  selector:
    matchLabels:
      app: crypto-sentiment-collector-working
  template:
    metadata:
      labels:
        app: crypto-sentiment-collector-working
        component: data-collector
        market-type: crypto
    spec:
      nodeSelector:
        node-type: data-collection
      tolerations:
        - key: "data-platform"
          operator: "Equal"
          value: "true"
          effect: "NoSchedule"
      containers:
        - name: crypto-sentiment-collector
          image: python:3.11-slim
          command: ["/bin/bash"]
          args:
            - "-c"
            - |
              set -e
              echo "ðŸš€ Starting Crypto Sentiment Service with CryptoBERT"

              # Install system dependencies
              apt-get update && apt-get install -y gcc g++ && rm -rf /var/lib/apt/lists/*

              # Install Python dependencies with CPU-only PyTorch
              pip install --no-cache-dir \
                fastapi==0.119.0 \
                uvicorn==0.37.0 \
                requests==2.32.5 \
                mysql-connector-python==9.4.0 \
                numpy==1.26.4 \
                --index-url https://download.pytorch.org/whl/cpu

              # Install transformers separately to avoid CUDA dependencies
              pip install --no-cache-dir transformers==4.44.0

              # Create the sentiment service
              cat > /app/sentiment.py << 'EOF'
              #!/usr/bin/env python3
              """
              Crypto Sentiment Service using CryptoBERT
              """

              import os
              import logging
              from fastapi import FastAPI, HTTPException
              from pydantic import BaseModel
              import uvicorn
              import requests

              # Configure logging
              logging.basicConfig(level=logging.INFO)
              logger = logging.getLogger(__name__)

              app = FastAPI(title="Crypto Sentiment Service", version="1.0.0")

              class SentimentRequest(BaseModel):
                  text: str
                  market_type: str = "crypto"

              class SentimentResponse(BaseModel):
                  sentiment_score: float
                  confidence: float
                  analysis: str
                  market_type: str
                  model_used: str

              @app.get("/health")
              async def health_check():
                  return {
                      "status": "healthy",
                      "service": "crypto-sentiment-collector-working",
                      "model_loaded": True
                  }

              @app.post("/sentiment", response_model=SentimentResponse)
              async def analyze_sentiment(request: SentimentRequest):
                  try:
                      # Use Hugging Face Inference API for CryptoBERT
                      api_url = "https://api-inference.huggingface.co/models/kk08/CryptoBERT"
                      headers = {"Authorization": f"Bearer {os.getenv('HF_TOKEN', '')}"}
                      
                      payload = {"inputs": request.text}
                      
                      response = requests.post(api_url, headers=headers, json=payload, timeout=30)
                      
                      if response.status_code == 200:
                          result = response.json()
                          
                          # Extract sentiment information
                          if isinstance(result, list) and len(result) > 0:
                              sentiment_data = result[0]
                              sentiment_label = sentiment_data.get("label", "NEUTRAL")
                              confidence = sentiment_data.get("score", 0.5)
                              
                              # Convert to numeric score
                              if sentiment_label == "POSITIVE":
                                  sentiment_score = confidence
                              elif sentiment_label == "NEGATIVE":
                                  sentiment_score = -confidence
                              else:
                                  sentiment_score = 0.0
                              
                              return SentimentResponse(
                                  sentiment_score=sentiment_score,
                                  confidence=confidence,
                                  analysis=f"CryptoBERT analysis: {sentiment_label} (confidence: {confidence:.3f})",
                                  market_type=request.market_type,
                                  model_used="kk08/CryptoBERT"
                              )
                          else:
                              # Fallback to simple sentiment
                              return SentimentResponse(
                                  sentiment_score=0.0,
                                  confidence=0.5,
                                  analysis="CryptoBERT analysis: neutral (fallback)",
                                  market_type=request.market_type,
                                  model_used="kk08/CryptoBERT-fallback"
                              )
                      else:
                          logger.error(f"Hugging Face API error: {response.status_code}")
                          # Fallback to simple sentiment
                          return SentimentResponse(
                              sentiment_score=0.0,
                              confidence=0.5,
                              analysis="CryptoBERT analysis: neutral (API error)",
                              market_type=request.market_type,
                              model_used="kk08/CryptoBERT-error"
                          )

                  except Exception as e:
                      logger.error(f"Error analyzing sentiment: {e}")
                      # Fallback to simple sentiment
                      return SentimentResponse(
                          sentiment_score=0.0,
                          confidence=0.5,
                          analysis=f"CryptoBERT analysis: neutral (error: {str(e)})",
                          market_type=request.market_type,
                          model_used="kk08/CryptoBERT-error"
                      )

              if __name__ == "__main__":
                  uvicorn.run(app, host="0.0.0.0", port=8000)
              EOF

              # Make the script executable
              chmod +x /app/sentiment.py

              # Start the service
              echo "ðŸš€ Starting sentiment service..."
              cd /app && python sentiment.py
          envFrom:
            - configMapRef:
                name: centralized-db-config
            - secretRef:
                name: centralized-db-secrets
          env:
            - name: MODEL_TYPE
              value: "crypto"
            - name: MODEL_NAME
              value: "cryptobert"
            - name: PORT
              value: "8000"
            - name: LOG_LEVEL
              value: "INFO"
            - name: HF_TOKEN
              value: "hf_placeholder" # Will be replaced with actual token
          resources:
            requests:
              cpu: 200m
              memory: 512Mi
            limits:
              cpu: 400m
              memory: 1Gi
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 15
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 3
---
apiVersion: v1
kind: Service
metadata:
  name: crypto-sentiment-collector-working
  namespace: crypto-data-collection
  labels:
    app: crypto-sentiment-collector-working
    component: data-collector
    market-type: crypto
spec:
  selector:
    app: crypto-sentiment-collector-working
  ports:
    - protocol: TCP
      port: 8000
      targetPort: 8000
  type: ClusterIP




