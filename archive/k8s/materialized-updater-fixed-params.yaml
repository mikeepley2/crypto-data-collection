apiVersion: apps/v1
kind: Deployment
metadata:
  name: materialized-updater
  namespace: crypto-data-collection
  labels:
    app: materialized-updater
    component: data-collector
spec:
  replicas: 1
  selector:
    matchLabels:
      app: materialized-updater
  template:
    metadata:
      labels:
        app: materialized-updater
        component: data-collector
    spec:
      tolerations:
        - key: data-platform
          operator: Equal
          value: "true"
          effect: NoSchedule
      containers:
        - name: materialized-updater
          image: python:3.11-slim
          command: ["/bin/bash", "-c"]
          args:
            - |
              pip install fastapi uvicorn mysql-connector-python requests

              # Create the materialized updater service
              cat > materialized_updater.py << 'EOF'
              #!/usr/bin/env python3
              """
              Materialized Updater with FIXED SQL parameter count
              """

              import os
              import time
              import mysql.connector
              from mysql.connector import pooling
              from datetime import datetime, timedelta
              import logging
              from decimal import Decimal

              # Configure logging
              logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
              logger = logging.getLogger('materialized-updater')

              # Database connection pool
              pool = None

              def init_pool():
                  """Initialize database connection pool"""
                  global pool
                  try:
                      pool = mysql.connector.pooling.MySQLConnectionPool(
                          pool_name="materialized_pool",
                          pool_size=5,
                          pool_reset_session=True,
                          host=os.getenv("MYSQL_HOST", "host.docker.internal"),
                          user=os.getenv("MYSQL_USER", "news_collector"),
                          password=os.getenv("MYSQL_PASSWORD", "99Rules!"),
                          database=os.getenv("MYSQL_DATABASE", "crypto_prices"),
                          charset="utf8mb4",
                          autocommit=True
                      )
                      logger.info("âœ… Database connection pool initialized")
                  except Exception as e:
                      logger.error(f"âŒ Failed to initialize database pool: {e}")

              def get_connection():
                  """Get connection from pool"""
                  try:
                      return pool.get_connection()
                  except Exception as e:
                      logger.error(f"âŒ Failed to get database connection: {e}")
                      return None

              def load_macro_indicators():
                  """Load macro indicators from macro_indicators table"""
                  indicators = {}
                  try:
                      conn = get_connection()
                      if not conn:
                          return indicators
                      
                      cursor = conn.cursor(dictionary=True)
                      
                      # Get the latest macro indicators - use indicator_date (correct column name)
                      query = """
                      SELECT indicator_name, value, indicator_date
                      FROM macro_indicators 
                      WHERE DATE(indicator_date) = CURDATE()
                      ORDER BY indicator_name, indicator_date DESC
                      """
                      
                      cursor.execute(query)
                      results = cursor.fetchall()
                      
                      for row in results:
                          indicators[row['indicator_name']] = row['value']
                      
                      cursor.close()
                      conn.close()
                      
                      logger.info(f"âœ… Loaded {len(indicators)} macro indicators: {list(indicators.keys())}")
                      
                  except Exception as e:
                      logger.error(f"âŒ Error loading macro indicators: {e}")
                  
                  return indicators

              def process_today_records():
                  """Process today's records with comprehensive data"""
                  try:
                      conn = get_connection()
                      if not conn:
                          return
                      
                      cursor = conn.cursor()
                      
                      # Load macro indicators
                      macro_indicators = load_macro_indicators()
                      
                      # Get today's price records - use available columns (no close_price)
                      query = """
                      SELECT symbol, timestamp_iso, current_price, price_change_24h, 
                             volume_usd_24h, market_cap, high_24h, low_24h, open_24h
                      FROM price_data_real 
                      WHERE DATE(timestamp_iso) = CURDATE()
                      ORDER BY symbol, timestamp_iso
                      """
                      
                      cursor.execute(query)
                      price_records = cursor.fetchall()
                      
                      logger.info(f"ðŸ“Š Processing {len(price_records)} today's price records")
                      
                      # Process each symbol
                      symbols_processed = 0
                      for symbol, timestamp_iso, current_price, price_change_24h, volume_usd_24h, market_cap, high_24h, low_24h, open_24h in price_records:
                          try:
                              # Get sentiment data
                              sentiment_query = """
                              SELECT AVG(ml_sentiment_score) as avg_sentiment, COUNT(*) as sentiment_count
                              FROM crypto_news 
                              WHERE crypto_mentions LIKE %s 
                              AND DATE(created_at) = CURDATE()
                              """
                              cursor.execute(sentiment_query, (f'%{symbol}%',))
                              sentiment_result = cursor.fetchone()
                              avg_sentiment = sentiment_result[0] if sentiment_result[0] else None
                              sentiment_count = sentiment_result[1] if sentiment_result[1] else 0
                              
                              # Get technical indicators
                              tech_query = """
                              SELECT sma_20, rsi_14, macd_line, macd_signal, macd_histogram,
                                     bb_upper, bb_middle, bb_lower
                              FROM technical_indicators 
                              WHERE symbol = %s 
                              AND DATE(timestamp_iso) = CURDATE()
                              ORDER BY timestamp_iso DESC 
                              LIMIT 1
                              """
                              cursor.execute(tech_query, (symbol,))
                              tech_result = cursor.fetchone()
                              
                              # Get onchain data - use onchain_metrics table (correct table name)
                              onchain_query = """
                              SELECT active_addresses_24h, transaction_count_24h, 
                                     exchange_net_flow_24h, price_volatility_7d
                              FROM onchain_metrics 
                              WHERE coin_symbol = %s 
                              AND DATE(collection_date) = CURDATE()
                              ORDER BY collection_date DESC 
                              LIMIT 1
                              """
                              cursor.execute(onchain_query, (symbol,))
                              onchain_result = cursor.fetchone()
                              
                              # Use current_price as close_price since close_price column doesn't exist
                              close_price = current_price
                              
                              # Prepare data for INSERT - COUNT: 34 parameters total
                              data = (
                                  symbol,  # 1
                                  timestamp_iso.date(),  # 2
                                  timestamp_iso.hour,  # 3
                                  timestamp_iso,  # 4
                                  current_price,  # 5
                                  price_change_24h,  # 6
                                  volume_usd_24h,  # 7
                                  market_cap,  # 8
                                  avg_sentiment,  # 9
                                  sentiment_count,  # 10
                                  onchain_result[0] if onchain_result and onchain_result[0] else None,  # 11
                                  onchain_result[1] if onchain_result and onchain_result[1] else None,  # 12
                                  onchain_result[2] if onchain_result and onchain_result[2] else None,  # 13
                                  onchain_result[3] if onchain_result and onchain_result[3] else None,  # 14
                                  tech_result[0] if tech_result and tech_result[0] else None,  # 15
                                  tech_result[1] if tech_result and tech_result[1] else None,  # 16
                                  tech_result[2] if tech_result and tech_result[2] else None,  # 17
                                  tech_result[3] if tech_result and tech_result[3] else None,  # 18
                                  tech_result[4] if tech_result and tech_result[4] else None,  # 19
                                  tech_result[5] if tech_result and tech_result[5] else None,  # 20
                                  tech_result[6] if tech_result and tech_result[6] else None,  # 21
                                  tech_result[7] if tech_result and tech_result[7] else None,  # 22
                                  macro_indicators.get('VIX'),  # 23
                                  macro_indicators.get('DXY'),  # 24
                                  macro_indicators.get('DGS10'),  # 25
                                  macro_indicators.get('UNEMPLOYMENT_RATE'),  # 26
                                  macro_indicators.get('INFLATION_RATE'),  # 27
                                  macro_indicators.get('GOLD'),  # 28
                                  macro_indicators.get('OIL'),  # 29
                                  close_price,  # 30
                                  close_price,  # 31
                                  datetime.now(),  # 32
                                  datetime.now()   # 33
                              )
                              
                              # INSERT ... ON DUPLICATE KEY UPDATE - 33 placeholders for 33 values
                              insert_query = """
                              INSERT INTO ml_features_materialized (
                                  symbol, price_date, price_hour, timestamp_iso, current_price, 
                                  price_change_24h, volume_24h, market_cap,
                                  avg_ml_overall_sentiment, sentiment_volume,
                                  active_addresses_24h, transaction_count_24h, exchange_net_flow_24h, price_volatility_7d,
                                  sma_20, rsi_14, macd_line, macd_signal, macd_histogram, bb_upper, bb_middle, bb_lower,
                                  vix, dxy, treasury_10y, unemployment_rate, inflation_rate, gold_price, oil_price,
                                  close_price, close,
                                  created_at, updated_at
                              ) VALUES (
                                  %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s
                              ) ON DUPLICATE KEY UPDATE
                                  current_price = VALUES(current_price),
                                  price_change_24h = VALUES(price_change_24h),
                                  volume_24h = VALUES(volume_24h),
                                  market_cap = VALUES(market_cap),
                                  avg_ml_overall_sentiment = VALUES(avg_ml_overall_sentiment),
                                  sentiment_volume = VALUES(sentiment_volume),
                                  active_addresses_24h = VALUES(active_addresses_24h),
                                  transaction_count_24h = VALUES(transaction_count_24h),
                                  exchange_net_flow_24h = VALUES(exchange_net_flow_24h),
                                  price_volatility_7d = VALUES(price_volatility_7d),
                                  sma_20 = VALUES(sma_20),
                                  rsi_14 = VALUES(rsi_14),
                                  macd_line = VALUES(macd_line),
                                  macd_signal = VALUES(macd_signal),
                                  macd_histogram = VALUES(macd_histogram),
                                  bb_upper = VALUES(bb_upper),
                                  bb_middle = VALUES(bb_middle),
                                  bb_lower = VALUES(bb_lower),
                                  vix = VALUES(vix),
                                  dxy = VALUES(dxy),
                                  treasury_10y = VALUES(treasury_10y),
                                  unemployment_rate = VALUES(unemployment_rate),
                                  inflation_rate = VALUES(inflation_rate),
                                  gold_price = VALUES(gold_price),
                                  oil_price = VALUES(oil_price),
                                  close_price = VALUES(close_price),
                                  close = VALUES(close),
                                  updated_at = VALUES(updated_at)
                              """
                              
                              cursor.execute(insert_query, data)
                              
                              symbols_processed += 1
                              if symbols_processed % 100 == 0:
                                  logger.info(f"ðŸ“Š Processed {symbols_processed} symbols...")
                              
                          except Exception as e:
                              logger.error(f"âŒ Error processing symbol {symbol}: {e}")
                              continue
                      
                      cursor.close()
                      conn.close()
                      
                      logger.info(f"âœ… Completed processing {symbols_processed} symbols for today")
                      
                  except Exception as e:
                      logger.error(f"âŒ Error processing today's records: {e}")

              def main():
                  """Main function"""
                  logger.info("Starting materialized updater with FIXED SQL parameter count (33 params)")
                  
                  # Initialize database pool
                  init_pool()
                  
                  if not pool:
                      logger.error("âŒ Failed to initialize database pool. Exiting.")
                      return
                  
                  # Process today's records
                  process_today_records()
                  
                  logger.info("âœ… Materialized updater completed successfully")

              if __name__ == "__main__":
                  main()
              EOF

              # Start the service
              python materialized_updater.py
          ports:
            - name: http
              containerPort: 8000
              protocol: TCP
          env:
            - name: MYSQL_HOST
              valueFrom:
                configMapKeyRef:
                  name: centralized-db-config
                  key: MYSQL_HOST
            - name: MYSQL_PORT
              valueFrom:
                configMapKeyRef:
                  name: centralized-db-config
                  key: MYSQL_PORT
            - name: MYSQL_USER
              valueFrom:
                secretKeyRef:
                  name: centralized-db-secrets
                  key: mysql-user
            - name: MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: centralized-db-secrets
                  key: mysql-password
            - name: MYSQL_DATABASE
              valueFrom:
                configMapKeyRef:
                  name: centralized-db-config
                  key: MYSQL_DATABASE
          resources:
            limits:
              cpu: 200m
              memory: 512Mi
            requests:
              cpu: 100m
              memory: 256Mi
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          imagePullPolicy: IfNotPresent
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
