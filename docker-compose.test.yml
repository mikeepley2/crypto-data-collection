version: '3.8'

services:
  # Test Database - MySQL to match production
  test-mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: test_root_password
      MYSQL_DATABASE: crypto_prices_test
      MYSQL_USER: test_user
      MYSQL_PASSWORD: test_password
    ports:
      - "3308:3306"  # Different port to avoid conflicts
    volumes:
      - test_mysql_data:/var/lib/mysql
      - ./tests/fixtures/test-schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
      - ./tests/fixtures/test-data.sql:/docker-entrypoint-initdb.d/02-data.sql
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 10s
      retries: 10
      interval: 10s
    networks:
      - test-network

  # Test Redis for caching
  test-redis:
    image: redis:7-alpine
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - test-network

  # Containerized Test Runner - No local dependencies needed
  test-runner:
    build:
      context: .
      dockerfile: tests/Dockerfile.test-runner
    environment:
      # Test database configuration
      - MYSQL_HOST=test-mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=test_user
      - MYSQL_PASSWORD=test_password
      - MYSQL_DATABASE=crypto_prices_test
      
      # Test Redis configuration
      - REDIS_HOST=test-redis
      - REDIS_PORT=6379
      
      # API keys for testing (use test keys)
      - COINGECKO_API_KEY=${COINGECKO_API_KEY:-test_coingecko_key}
      - FRED_API_KEY=${FRED_API_KEY:-test_fred_key}
      - GUARDIAN_API_KEY=${GUARDIAN_API_KEY:-test_guardian_key}
      
      # Test mode flags
      - ENVIRONMENT=test
      - TESTING=true
      - PYTEST_CURRENT_TEST=true
      - PYTHONPATH=/app
      - LOG_LEVEL=INFO
    depends_on:
      test-mysql:
        condition: service_healthy
      test-redis:
        condition: service_healthy
    volumes:
      - .:/app
      - test_results:/app/test-results
      - test_coverage:/app/htmlcov
    working_dir: /app
    networks:
      - test-network
    # Override for different test types
    command: >
      bash -c "
        echo 'ðŸ§ª Starting Containerized Test Suite'
        echo 'ðŸ›¡ï¸  Using isolated test database (test-mysql:3306)'
        echo 'ðŸ“Š Test environment verified'
        
        # Wait for services to be fully ready
        echo 'â³ Waiting for services to be ready...'
        sleep 15
        
        # Verify database connectivity
        echo 'ðŸ” Verifying test database connection...'
        python -c 'import mysql.connector; conn=mysql.connector.connect(host=\"test-mysql\", port=3306, user=\"test_user\", password=\"test_password\", database=\"crypto_prices_test\"); print(\"âœ… Test database connected:\", conn.connection_id); conn.close()'
        
        # Run comprehensive test suite
        echo 'ðŸš€ Running integration tests...'
        python tests/test_ohlc_integration.py
        
        echo 'ðŸ“‹ Running unit tests...'
        pytest tests/test_real_endpoint_validation.py -v
        
        echo 'ðŸŽ¯ Running all tests with coverage...'
        pytest tests/ -v --tb=short --cov=services --cov-report=html --cov-report=term-missing --durations=10 --junitxml=test-results/results.xml
        
        echo 'âœ… All tests completed'
      "

  # Quick test runner for CI/CD (just integration tests)
  test-integration:
    build:
      context: .
      dockerfile: tests/Dockerfile.test-runner
    environment:
      - MYSQL_HOST=test-mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=test_user
      - MYSQL_PASSWORD=test_password
      - MYSQL_DATABASE=crypto_prices_test
      - REDIS_HOST=test-redis
      - REDIS_PORT=6379
      - ENVIRONMENT=test
      - TESTING=true
      - PYTHONPATH=/app
    depends_on:
      test-mysql:
        condition: service_healthy
      test-redis:
        condition: service_healthy
    volumes:
      - .:/app
    working_dir: /app
    networks:
      - test-network
    command: >
      bash -c "
        echo 'ðŸ§ª Comprehensive Integration Test Suite'
        sleep 10
        echo 'ðŸ” Running original OHLC integration tests...'
        pytest tests/test_ohlc_integration.py -v --tb=short
        echo 'ðŸ” Running comprehensive service integration tests...'
        pytest tests/test_pytest_comprehensive_integration.py -v --tb=short
        echo 'ðŸ” Running comprehensive service integration script...'
        python tests/test_comprehensive_service_integration.py
      "

  # Comprehensive test runner (all services)
  test-all-services:
    build:
      context: .
      dockerfile: tests/Dockerfile.test-runner
    environment:
      - MYSQL_HOST=test-mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=test_user
      - MYSQL_PASSWORD=test_password
      - MYSQL_DATABASE=crypto_prices_test
      - REDIS_HOST=test-redis
      - REDIS_PORT=6379
      - ENVIRONMENT=test
      - TESTING=true
      - PYTHONPATH=/app
    depends_on:
      test-mysql:
        condition: service_healthy
      test-redis:
        condition: service_healthy
    volumes:
      - .:/app
      - test_results:/app/test-results
      - test_coverage:/app/htmlcov
    working_dir: /app
    networks:
      - test-network
    command: >
      bash -c "
        echo 'ðŸš€ COMPREHENSIVE SERVICE INTEGRATION TESTS'
        echo '============================================='
        sleep 15
        
        echo 'ðŸ” Running all integration tests with coverage...'
        pytest tests/test_ohlc_integration.py tests/test_pytest_comprehensive_integration.py tests/test_real_endpoint_validation.py -v --cov=services --cov-report=html --cov-report=term-missing --durations=10 --junitxml=test-results/comprehensive-results.xml
        
        echo 'ðŸ” Running comprehensive service integration script...'
        python tests/test_comprehensive_service_integration.py
        
        echo 'âœ… All comprehensive tests completed'
      "

  # Unit test runner (fast, no database dependencies)
  test-unit:
    build:
      context: .
      dockerfile: tests/Dockerfile.test-runner
    environment:
      - ENVIRONMENT=test
      - TESTING=true
      - PYTHONPATH=/app
    volumes:
      - .:/app
      - test_results:/app/test-results
    working_dir: /app
    networks:
      - test-network
    command: >
      bash -c "
        echo 'âš¡ Fast Unit Test Suite'
        pytest tests/test_real_endpoint_validation.py tests/test_comprehensive_endpoints.py -v --tb=short --durations=5
      "

volumes:
  test_mysql_data:
  test_results:
  test_coverage:

networks:
  test-network:
    name: crypto-test-network
