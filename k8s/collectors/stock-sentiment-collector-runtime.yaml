apiVersion: apps/v1
kind: Deployment
metadata:
  name: stock-sentiment-collector-runtime
  namespace: crypto-data-collection
  labels:
    app: stock-sentiment-collector-runtime
    component: data-collector
    market-type: stock
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8000"
    prometheus.io/path: "/metrics"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: stock-sentiment-collector-runtime
  template:
    metadata:
      labels:
        app: stock-sentiment-collector-runtime
        component: data-collector
        market-type: stock
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8000"
        prometheus.io/path: "/metrics"
    spec:
      nodeSelector:
        node-type: data-collection
      tolerations:
        - key: "data-platform"
          operator: "Equal"
          value: "true"
          effect: "NoSchedule"
      containers:
        - name: stock-sentiment-collector
          image: python:3.11-slim
          command: ["/bin/bash"]
          args:
            - -c
            - |
              set -e
              echo "ðŸš€ Starting Stock Sentiment Service with FinBERT"

              # Install system dependencies
              apt-get update && apt-get install -y gcc g++ && rm -rf /var/lib/apt/lists/*

              # Install Python dependencies
              pip install --no-cache-dir \
                fastapi==0.119.0 \
                uvicorn==0.37.0 \
                transformers==4.44.0 \
                torch==2.4.0 \
                requests==2.32.5 \
                mysql-connector-python==9.4.0 \
                numpy==1.26.4

              # Download FinBERT model
              echo "ðŸ“¥ Downloading FinBERT model..."
              python -c "
              from transformers import AutoTokenizer, AutoModelForSequenceClassification, pipeline
              import os

              model_name = 'ProsusAI/finbert'
              print(f'Downloading {model_name}...')

              tokenizer = AutoTokenizer.from_pretrained(model_name)
              model = AutoModelForSequenceClassification.from_pretrained(model_name)

              # Create sentiment pipeline
              sentiment_pipeline = pipeline(
                  'sentiment-analysis',
                  model=model,
                  tokenizer=tokenizer,
                  device=-1  # CPU only
              )

              # Test the pipeline
              test_result = sentiment_pipeline('Stock market shows strong performance')
              print(f'âœ… Model loaded and tested: {test_result}')
              "

              # Create the sentiment service
              cat > /app/sentiment.py << 'EOF'
              #!/usr/bin/env python3
              """
              Stock Sentiment Service using FinBERT
              """

              import os
              import logging
              from fastapi import FastAPI, HTTPException
              from pydantic import BaseModel
              from transformers import AutoTokenizer, AutoModelForSequenceClassification, pipeline
              import uvicorn

              # Configure logging
              logging.basicConfig(level=logging.INFO)
              logger = logging.getLogger(__name__)

              app = FastAPI(title="Stock Sentiment Service", version="1.0.0")

              # Global variables for model
              sentiment_pipeline = None

              class SentimentRequest(BaseModel):
                  text: str
                  market_type: str = "stock"

              class SentimentResponse(BaseModel):
                  sentiment_score: float
                  confidence: float
                  analysis: str
                  market_type: str
                  model_used: str

              @app.on_event("startup")
              async def load_model():
                  global sentiment_pipeline
                  try:
                      logger.info("ðŸ”„ Loading FinBERT model...")
                      model_name = "ProsusAI/finbert"
                      
                      tokenizer = AutoTokenizer.from_pretrained(model_name)
                      model = AutoModelForSequenceClassification.from_pretrained(model_name)
                      
                      sentiment_pipeline = pipeline(
                          "sentiment-analysis",
                          model=model,
                          tokenizer=tokenizer,
                          device=-1  # CPU only
                      )
                      
                      logger.info("âœ… FinBERT model loaded successfully")
                  except Exception as e:
                      logger.error(f"âŒ Failed to load model: {e}")
                      raise

              @app.get("/health")
              async def health_check():
                  return {
                      "status": "healthy",
                      "model_loaded": sentiment_pipeline is not None,
                      "service": "stock-sentiment-collector-runtime"
                  }

              @app.post("/sentiment", response_model=SentimentResponse)
              async def analyze_sentiment(request: SentimentRequest):
                  if sentiment_pipeline is None:
                      raise HTTPException(status_code=503, detail="Model not loaded")
                  
                  try:
                      # Analyze sentiment
                      result = sentiment_pipeline(request.text)
                      
                      # Extract sentiment information
                      sentiment_label = result[0]["label"]
                      confidence = result[0]["score"]
                      
                      # Convert to numeric score
                      if sentiment_label == "positive":
                          sentiment_score = confidence
                      elif sentiment_label == "negative":
                          sentiment_score = -confidence
                      else:
                          sentiment_score = 0.0
                      
                      return SentimentResponse(
                          sentiment_score=sentiment_score,
                          confidence=confidence,
                          analysis=f"FinBERT analysis: {sentiment_label} (confidence: {confidence:.3f})",
                          market_type=request.market_type,
                          model_used="ProsusAI/finbert"
                      )
                      
                  except Exception as e:
                      logger.error(f"Error analyzing sentiment: {e}")
                      raise HTTPException(status_code=500, detail=str(e))

              if __name__ == "__main__":
                  uvicorn.run(app, host="0.0.0.0", port=8000)
              EOF

              # Make the script executable
              chmod +x /app/sentiment.py

              # Start the service
              echo "ðŸš€ Starting sentiment service..."
              cd /app && python sentiment.py
          ports:
            - containerPort: 8000
              name: http
          env:
            - name: MYSQL_HOST
              valueFrom:
                configMapKeyRef:
                  name: centralized-db-config
                  key: MYSQL_HOST
            - name: MYSQL_PORT
              valueFrom:
                configMapKeyRef:
                  name: centralized-db-config
                  key: MYSQL_PORT
            - name: MYSQL_USER
              valueFrom:
                secretKeyRef:
                  name: centralized-db-secrets
                  key: mysql-user
            - name: MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: centralized-db-secrets
                  key: mysql-password
            - name: MYSQL_DATABASE
              valueFrom:
                configMapKeyRef:
                  name: centralized-db-config
                  key: MYSQL_DATABASE
            - name: MODEL_TYPE
              value: "stock"
            - name: MODEL_NAME
              value: "finbert"
            - name: PORT
              value: "8000"
            - name: LOG_LEVEL
              value: "INFO"
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 1000m
              memory: 2Gi
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 300 # Longer delay for model loading
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 180
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 5
---
apiVersion: v1
kind: Service
metadata:
  name: stock-sentiment-collector-runtime
  namespace: crypto-data-collection
  labels:
    app: stock-sentiment-collector-runtime
    component: data-collector
    market-type: stock
spec:
  selector:
    app: stock-sentiment-collector-runtime
  ports:
    - protocol: TCP
      port: 8000
      targetPort: 8000
  type: ClusterIP
