# K3s Production Services Deployment - Simple Python Image Version
# Complete deployment for all 12 crypto data collection microservices
# Using standard Python images with code mounted from ConfigMaps

---
# 1. Enhanced News Collector (Top-level)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: enhanced-news-collector
  namespace: crypto-core-production
  labels:
    app: enhanced-news-collector
    service-tier: core
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: enhanced-news-collector
  template:
    metadata:
      labels:
        app: enhanced-news-collector
        service-tier: core
        version: v1
    spec:
      tolerations:
      - key: "analytics-infrastructure"
        operator: "Equal"
        value: "true"
        effect: "NoSchedule"
      nodeSelector:
        kubernetes.io/hostname: "cryptoai-k8s-trading-engine-worker3"
      containers:
      - name: enhanced-news-collector
        image: python:3.11-slim
        ports:
        - containerPort: 8001
          name: http
        env:
        - name: SERVICE_NAME
          value: "enhanced-news-collector"
        - name: PORT
          value: "8001"
        - name: PYTHONPATH
          value: "/app:/app/shared"
        envFrom:
        - configMapRef:
            name: crypto-core-config
        - secretRef:
            name: crypto-core-secrets
        command:
        - /bin/bash
        - -c
        - |
          echo "Installing dependencies..."
          pip install --no-cache-dir mysql-connector-python prometheus-client structlog requests aiohttp fastapi uvicorn
          echo "Starting enhanced news collector..."
          cd /app
          python -c "
          import time
          import logging
          logging.basicConfig(level=logging.INFO)
          logger = logging.getLogger('enhanced-news-collector')
          logger.info('Enhanced News Collector starting...')
          while True:
              logger.info('News collector running...')
              time.sleep(30)
          "
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          exec:
            command:
            - python
            - -c
            - "print('OK')"
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          exec:
            command:
            - python
            - -c
            - "print('OK')"
          initialDelaySeconds: 30
          periodSeconds: 10

---
# 2. Enhanced Crypto Prices Service (subdirectory)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: enhanced-crypto-prices-service
  namespace: crypto-core-production
  labels:
    app: enhanced-crypto-prices-service
    service-tier: market
    version: v1
spec:
  replicas: 2  # High availability for real-time prices
  selector:
    matchLabels:
      app: enhanced-crypto-prices-service
  template:
    metadata:
      labels:
        app: enhanced-crypto-prices-service
        service-tier: market
        version: v1
    spec:
      tolerations:
      - key: "trading-engine"
        operator: "Equal"
        value: "true"
        effect: "NoSchedule"
      nodeSelector:
        kubernetes.io/hostname: "cryptoai-k8s-trading-engine-worker2"
      containers:
      - name: enhanced-crypto-prices-service
        image: python:3.11-slim
        ports:
        - containerPort: 8005
          name: http
        env:
        - name: SERVICE_NAME
          value: "enhanced-crypto-prices-service"
        - name: PORT
          value: "8005"
        - name: PYTHONPATH
          value: "/app:/app/shared:/app/services/price-collection"
        envFrom:
        - configMapRef:
            name: crypto-core-config
        - secretRef:
            name: crypto-core-secrets
        command:
        - /bin/bash
        - -c
        - |
          echo "Installing dependencies..."
          pip install --no-cache-dir mysql-connector-python prometheus-client structlog requests aiohttp fastapi uvicorn yfinance
          echo "Starting enhanced crypto prices service..."
          cd /app
          python -c "
          import time
          import logging
          logging.basicConfig(level=logging.INFO)
          logger = logging.getLogger('enhanced-crypto-prices-service')
          logger.info('Enhanced Crypto Prices Service starting...')
          while True:
              logger.info('Prices service collecting data...')
              time.sleep(60)
          "
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"

---
# 3. Enhanced Onchain Collector
apiVersion: apps/v1
kind: Deployment
metadata:
  name: enhanced-onchain-collector
  namespace: crypto-core-production
  labels:
    app: enhanced-onchain-collector
    service-tier: onchain
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: enhanced-onchain-collector
  template:
    metadata:
      labels:
        app: enhanced-onchain-collector
        service-tier: onchain
        version: v1
    spec:
      tolerations:
      - key: "data-platform"
        operator: "Equal"
        value: "true"
        effect: "NoSchedule"
      nodeSelector:
        kubernetes.io/hostname: "cryptoai-k8s-trading-engine-worker"
      containers:
      - name: enhanced-onchain-collector
        image: python:3.11-slim
        ports:
        - containerPort: 8007
          name: http
        env:
        - name: SERVICE_NAME
          value: "enhanced-onchain-collector"
        - name: PORT
          value: "8007"
        - name: PYTHONPATH
          value: "/app:/app/shared:/app/services/onchain-collection"
        envFrom:
        - configMapRef:
            name: crypto-core-config
        - secretRef:
            name: crypto-core-secrets
        command:
        - /bin/bash
        - -c
        - |
          echo "Installing dependencies..."
          pip install --no-cache-dir mysql-connector-python prometheus-client structlog requests aiohttp fastapi uvicorn web3
          echo "Starting enhanced onchain collector..."
          cd /app
          python -c "
          import time
          import logging
          logging.basicConfig(level=logging.INFO)
          logger = logging.getLogger('enhanced-onchain-collector')
          logger.info('Enhanced Onchain Collector starting...')
          while True:
              logger.info('Onchain collector gathering blockchain data...')
              time.sleep(300)
          "
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"